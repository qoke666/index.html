<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TMA Главная</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: #080808;
      color: #ffffff;
      overflow-y: auto;
    }
    a { text-decoration: none; }
    ul { list-style: none; margin: 0; padding: 0; }
    .menu-top { display: flex; justify-content: flex-start; align-items: center; padding: 16px; }
    .menu-top .logo { width: 100px; }
    .carousel {
      position: relative;
      width: 343px;
      height: 136px;
      margin: 0 auto;
      border-radius: 12px;
      overflow: hidden;
      background: #000;
      max-width: 100%;
    }
    .carousel a {
      display: block;
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      opacity: 0;
      transition: opacity .5s;
    }
    .carousel a.active { opacity: 1; z-index: 1; }
    .carousel img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .carousel .hot {
      position: absolute;
      top: 8px;
      left: 16px;
      font-size: 20px;
      font-weight: 500;
      color: #ffffff;
      z-index: 2;
    }
    .carousel-dots {
      position: absolute;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 5px;
      z-index: 2;
    }
    .carousel-dots .dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      cursor: pointer;
    }
    .carousel-dots .dot.active { background: rgba(255,255,255,0.9); }
    .menu {
      display: flex;
      justify-content: center;
      background: #080808;
      padding: 12px 0;
      position: sticky;
      top: 0;
      z-index: 10;
      max-width: 100%;
    }
    .menu ul {
      display: inline-flex;
      gap: 10px;
      padding: 0 16px;
      overflow-x: auto;
      white-space: nowrap;
      scroll-behavior: smooth;
      touch-action: pan-x;
      -webkit-overflow-scrolling: touch;
    }
    .menu ul::-webkit-scrollbar { display: none; }
    .menu-item {
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      color: #ccc;
      transition: background .3s, color .3s;
    }
    .menu-item.active, .menu-item:hover {
      background: #d5fd02;
      color: #080808;
    }
    .section {
      display: none;
      padding: 24px 16px;
      box-sizing: border-box;
    }
    .section.active { display: block; }
    .back-button {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 16px;
      padding: 6px 12px;
      background: #d5fd02;
      color: #080808;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
    }
    .section-title {
      font-size: 24px;
      font-weight: 600;
      margin: 24px 0;
      color: #d5fd02;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
    }
    .card {
      background: #111315;
      border: 1px solid #222;
      border-radius: 12px;
      color: #ccc;
      transition: transform .2s;
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }
    .card:hover { transform: scale(1.02); }
    #home .card img, #articles .card img, #cases .card img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      display: block;
    }
    #vacancies .card, #offers .card {
      padding: 12px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .card .text-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.6);
      padding: 8px;
    }
    .card strong {
      display: block;
      font-size: 14px;
      color: #ffffff;
      margin-bottom: 4px;
    }
    .card p {
      font-size: 12px;
      color: #bbb;
      margin: 0;
    }
    #vacancies .promo-card {
      grid-column: 1 / -1;
      background: #1a1d21;
      padding: 16px;
      text-align: center;
      font-size: 16px;
      font-weight: 600;
      color: #d5fd02;
      border-radius: 12px;
      cursor: pointer;
    }
    #vacancies .promo-card:hover { transform: scale(1.02); }
    #team .card img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      margin-bottom: 8px;
      border-radius: 50%;
    }
    .team-carousel {
      margin: 16px 0;
      max-width: 100%;
      overflow: hidden;
    }
    .team-list {
      display: inline-flex;
      gap: 12px;
      padding: 0 16px;
      overflow-x: auto;
      white-space: nowrap;
      scroll-behavior: smooth;
      touch-action: pan-x;
      -webkit-overflow-scrolling: touch;
      width: 100%;
      box-sizing: border-box;
    }
    .team-list::-webkit-scrollbar { display: none; }
    .team-item {
      flex: 0 0 160px;
      padding: 12px;
      text-align: center;
      transition: transform .2s;
    }
    .team-item:hover { transform: scale(1.02); }
    .team-item img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 50%;
      margin: 0 auto 8px;
      display: block;
    }
    .team-item strong {
      display: block;
      font-size: 14px;
      color: #ffffff;
      margin-bottom: 4px;
    }
    .team-item p {
      font-size: 12px;
      color: #bbb;
      margin: 0;
    }
    .actual-list-container {
      margin: 16px 0;
      max-width: 100%;
      overflow: hidden;
    }
    .actual-list {
      display: inline-flex;
      gap: 12px;
      padding: 0 16px;
      overflow-x: auto;
      white-space: nowrap;
      scroll-behavior: smooth;
      touch-action: pan-x;
      -webkit-overflow-scrolling: touch;
      width: 100%;
      box-sizing: border-box;
    }
    .actual-list::-webkit-scrollbar { display: none; }
    .actual-item { flex: 0 0 160px; }
    .actual-item .card {
      border-radius: 12px;
      overflow: hidden;
      display: block;
    }
    .actual-item .card img {
      border-radius: 12px 12px 0 0;
      width: 100%;
      height: 120px;
      object-fit: cover;
    }
    #offers .card {
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    #offers .card strong {
      font-size: 16px;
      color: #d5fd02;
    }
    #offers .card p {
      font-size: 14px;
      color: #ccc;
      margin: 0;
      line-height: 1.4;
    }
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #111315;
      border: 1px solid #222;
      border-radius: 12px;
      padding: 16px;
      z-index: 9999;
      color: #fff;
      max-width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-sizing: border-box;
    }
    .modal h3 {
      margin: 0 0 12px;
      color: #d5fd02;
      font-size: 20px;
    }
    .modal p {
      font-size: 14px;
      color: #ccc;
      margin: 8px 0;
    }
    .modal .apply-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 16px;
    }
    .modal .apply-form select,
    .modal .apply-form input,
    .modal .apply-form textarea {
      padding: 8px;
      border: 1px solid #222;
      border-radius: 6px;
      background: #111315;
      color: #fff;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
    }
    .modal .apply-form select {
      appearance: none;
      background-image: url('data:image/svg+xml;utf8,<svg fill="%23ccc" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 8px center;
      background-size: 16px;
    }
    .modal .apply-form textarea {
      resize: vertical;
      min-height: 100px;
    }
    .modal .apply-form button {
      padding: 8px 16px;
      background: #d5fd02;
      color: #080808;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
    }
    .modal .apply-form .close-button {
      padding: 8px 16px;
      background: #222;
      color: #fff;
      border: 1px solid #444;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      margin-top: 8px;
    }
    .modal .apply-form .subscribe-button {
      display: inline-block;
      padding: 8px 16px;
      background: #d5fd02;
      color: #080808;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="menu-top">
    <img class="logo" src="https://i.postimg.cc/90gRT1n1/Frame-277131232-2.png" alt="TMA Logo" />
  </div>

  <div class="carousel">
    <a href="#" class="active"><img src="https://i.postimg.cc/yNL8QJ8S/owner-02-3.jpg" alt="Тихон" /></a>
    <a href="#"><img src="https://i.postimg.cc/bJqQWjv5/photo-2025-03-18-15-18-14.jpg" alt="SCAM кейс" /></a>
    <a href="#"><img src="https://i.postimg.cc/Z57qjBRv/feat-mac.jpg" alt="мак" /></a>
    <div class="hot"></div>
    <div class="carousel-dots">
      <div class="dot active"></div>
      <div class="dot"></div>
      <div class="dot"></div>
    </div>
  </div>

  <nav class="menu">
    <ul>
      <li class="menu-item active" data-section="home">Главная</li>
      <li class="menu-item" data-section="articles">Статьи</li>
      <li class="menu-item" data-section="cases">Кейсы</li>
      <li class="menu-item" data-section="vacancies">Вакансии</li>
      <li class="menu-item" data-section="offers">Офферы</li>
    </ul>
  </nav>

  <section id="home" class="section active">
    <h2 class="section-title">АКТУАЛЬНОЕ</h2>
    <div class="actual-list-container">
      <ul class="actual-list">
        <li class="actual-item">
          <a class="card" href="#" data-id="actual_1" data-title="Гемблинг кейс: $130 000+">
            <img src="https://i.postimg.cc/7PGWRRNZ/130k.jpg" alt="Гемблинг кейс" />
            <div class="text-overlay">
              <strong>Гемблинг кейс: $130 000+</strong>
              <p>Заработок за 2 месяца с ASO в Бразилии</p>
            </div>
          </a>
        </li>
        <!-- ... другие актуальные ... -->
      </ul>
    </div>
    <h2 class="section-title">КОМАНДА</h2>
    <div class="team-carousel">
      <ul class="team-list">
        <li class="team-item">
          <a href="#"><img src="https://i.postimg.cc/yN5SkL2P/3.webp" alt="Evgenii" />
            <strong>Evgenii Limited</strong>
            <p>Co-owner</p>
          </a>
        </li>
        <!-- ... другие члены команды ... -->
      </ul>
    </div>
  </section>

  <section id="articles" class="section">
    <h2 class="section-title">СТАТЬИ</h2>
    <div class="grid">
      <a class="card" href="#"><img src="https://i.postimg.cc/JzZmWnct/quality.jpg" alt="Статья 1" />
        <div class="text-overlay">
          <strong>Качество трафика</strong>
          <p>Несколько практических механик</p>
        </div>
      </a>
      <!-- ... другие статьи ... -->
    </div>
  </section>

  <section id="cases" class="section">
    <h2 class="section-title">КЕЙСЫ</h2>
    <div class="grid">
      <a class="card" href="#"><img src="https://i.postimg.cc/7PGWRRNZ/130k.jpg" alt="Гемблинг кейс" />
        <div class="text-overlay">
          <strong>Гемблинг кейс: $130 000+</strong>
          <p>Заработок за 2 месяца</p>
        </div>
      </a>
      <!-- ... другие кейсы ... -->
    </div>
  </section>

  <section id="vacancies" class="section">
    <h2 class="section-title">ВАКАНСИИ</h2>
    <div class="grid">
      <div class="promo-card" data-vacancy-id="tlc_promo">TLC Для медиабайеров, тимлидов, овнеров команд</div>
      <div class="card" data-vacancy-id="smm1">
        <strong>SMM-менеджер</strong>
        <p>Опыт: от 1 года</p>
        <p>Формат: Удалённо</p>
        <p>Зарплата: от 80 000 RUB</p>
      </div>
      <div class="card" data-vacancy-id="smm2">
        <strong>SMM-менеджер (Senior)</strong>
        <p>Опыт: от 3 лет</p>
        <p>Формат: Удалённо</p>
        <p>Зарплата: от 120 000 RUB</p>
      </div>
    </div>
  </section>

  <section id="offers" class="section">
    <h2 class="section-title">ОФФЕРЫ</h2>
    <div class="grid">
      <a class="card" href="#"><strong>Источник: ASO</strong><p>ГЕО: FR</p><p>Ставка: 160 EUR</p><p>Mindep: 10 EUR</p></a>
      <!-- ... другие офферы ... -->
    </div>
  </section>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    console.log('Script loaded');
    const tg = window.Telegram.WebApp;
    if (tg) {
      tg.expand();
      console.log('Telegram Web App initialized');
    }
    let user_id = null, username = null, first_name = null, last_name = null;
    if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
      ({ id: user_id, username, first_name, last_name } = tg.initDataUnsafe.user);
      console.log('User data:', { user_id, username, first_name, last_name });
    }
    const SHEET_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwOD2PwFx1MkacHYKe-hCt2CKj7z-qMATVLUbfWymPs-TrkJJHt0bEEdviV29tQEqa4yQ/exec';

    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    function sendToSheet(data) {
      fetch(SHEET_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      }).catch(error => console.error('Fetch error:', error));
    }

    function trackEvent(eventName, additional = {}) {
      sendToSheet({
        event: eventName,
        user_id,
        username,
        first_name,
        last_name,
        userAgent: navigator.userAgent,
        timestamp: new Date().toISOString(),
        additional
      });
    }

    trackEvent('webapp_open');

    document.querySelectorAll('.menu-item').forEach(item => {
      item.addEventListener('click', () => {
        trackEvent('nav_click', { section: item.dataset.section });
        document.querySelectorAll('.section').forEach(sec => sec.classList.toggle('active', sec.id === item.dataset.section));
        document.querySelectorAll('.menu-item').forEach(i => i.classList.toggle('active', i.dataset.section === item.dataset.section));
        window.scrollTo(0, 0);
      });
    });

    document.querySelectorAll('.card, .team-item a').forEach(card => {
      card.addEventListener('click', (e) => {
        if (e.target.closest('.apply-form') || card.closest('#vacancies')) return;
        const title = card.querySelector('strong')?.innerText || 'Unknown';
        trackEvent('card_click', { title });
      });
    });

    document.querySelectorAll('.carousel a').forEach(slide => {
      slide.addEventListener('click', () => {
        const alt = slide.querySelector('img')?.getAttribute('alt') || 'Unknown';
        trackEvent('carousel_click', { slide: alt });
      });
    });

    document.querySelectorAll('.carousel-dots .dot').forEach((dot, i) => {
      dot.addEventListener('click', () => {
        trackEvent('carousel_dot_click', { slideIndex: i });
        document.querySelectorAll('.carousel a').forEach((slide, index) => slide.classList.toggle('active', index === i));
        document.querySelectorAll('.carousel-dots .dot').forEach((d, index) => d.classList.toggle('active', index === i));
      });
    });

    const scrollableLists = document.querySelectorAll('.menu ul, .team-list, .actual-list');
    scrollableLists.forEach(list => {
      list.addEventListener('wheel', (e) => {
        e.preventDefault();
        const delta = Math.abs(e.deltaX) > Math.abs(e.deltaY) ? e.deltaX : e.deltaY;
        list.scrollLeft += delta * 2.5;
      });
    });

    const vacancyData = {
      smm1: {
        title: 'SMM-менеджер',
        experience: 'от 1 года',
        format: 'Удалённо',
        salary: 'от 80 000 RUB',
        description: 'Ведение социальных сетей, создание и публикация контента, взаимодействие с аудиторией, разработка SMM-стратегии.',
        requirements: 'Опыт работы в SMM от 1 года, знание инструментов аналитики, креативность, умение работать с Canva или аналогами.'
      },
      smm2: {
        title: 'SMM-менеджер (Senior)',
        experience: 'от 3 лет',
        format: 'Удалённо',
        salary: 'от 120 000 RUB',
        description: 'Разработка и реализация SMM-стратегий, управление командой, работа с крупными бюджетами, анализ эффективности кампаний.',
        requirements: 'Опыт работы в SMM от 3 лет, навыки управления проектами, глубокое знание аналитики и рекламных кабинетов.'
      },
      tlc_promo: {
        title: 'TLC Для медиабайеров, тимлидов, овнеров команд',
        description: 'TLC обладает ресурсами и отлаженной инфраструктурой для интеграции и масштабирования дохода и экспертизы как медиабайеров, так и целых команд, работающих с любым источником трафика в вертикалях iGaming, Betting, Finance.',
        offers: `
          <strong>Что мы предлагаем:</strong><br>
          1️⃣ Неограниченные финансовые ресурсы на работу с трафиком и тестирование гипотез<br>
          2️⃣ Развитую инфраструктуру и снабжение всеми необходимыми расходниками и техническими решениями для работы в любом источнике<br>
          3️⃣ Приватные условия работы с рекламодателями и продажу вашего трафика с максимальной прибылью<br>
          4️⃣ Возможность вырасти внутри холдинга и развиваться медийно: поможем собрать команду под себя или масштабировать уже существующую
        `
      }
    };

    function renderForm(vacancyId, position = '') {
      let formContent = `
        <label>Ваш Telegram (например, @username)</label>
        <input type="text" name="telegram" placeholder="@username" pattern="@[A-Za-z0-9_]{5,32}" title="Введите Telegram-username, начиная с @" required>
      `;
      if (vacancyData[vacancyId] && vacancyId === 'tlc_promo') {
        if (position === 'Владелец команды') {
          formContent += `
            <label>Каков твой опыт в вертикалях iGaming/Betting/Finance?</label>
            <select name="experience" required>
              <option value="" disabled selected>Выберите опыт</option>
              <option value="3+ года">3+ года</option>
              <option value="1-2 года">1-2 года</option>
              <option value="6-12 месяцев">6-12 месяцев</option>
              <option value="менее 6 месяцев">менее 6 месяцев</option>
            </select>
            <label>С каким источником работаешь?</label>
            <select name="source" required>
              <option value="" disabled selected>Выберите источник</option>
              <option value="FB">FB</option>
              <option value="PPC">PPC</option>
              <option value="ASO">ASO</option>
              <option value="SEO">SEO</option>
            </select>
            <label>Сколько человек в команде?</label>
            <select name="team_size" required>
              <option value="" disabled selected>Выберите размер</option>
              <option value="1-4">1-4</option>
              <option value="5-9">5-9</option>
              <option value="10-14">10-14</option>
              <option value="15+">15+</option>
            </select>
            <label>Каков средний спенд и профит команды в месяц за последние полгода?</label>
            <textarea name="spend_profit" placeholder="Опишите спенд и профит" required></textarea>
            <label>Почему вы решили привлечь инвестиции в свою команду?</label>
            <textarea name="investment_reason" placeholder="Причина привлечения" required></textarea>
          `;
        } else if (position === 'Тимлид' || position === 'Медиабайер') {
          formContent += `
            <label>Как тебя зовут?</label>
            <input type="text" name="name" placeholder="Ваше имя" required>
            <label>В каком городе ты живёшь?</label>
            <input type="text" name="city" placeholder="Город" required>
            <label>Каков твой опыт в вертикалях iGaming/Betting/Finance?</label>
            <select name="experience" required>
              <option value="" disabled selected>Выберите опыт</option>
              <option value="3+ года">3+ года</option>
              <option value="1-2 года">1-2 года</option>
              <option value="6-12 месяцев">6-12 месяцев</option>
              <option value="менее 6 месяцев">менее 6 месяцев</option>
            </select>
            <label>Твой источник?</label>
            <select name="source" required>
              <option value="" disabled selected>Выберите источник</option>
              <option value="FB">FB</option>
              <option value="PPC">PPC</option>
              <option value="ASO">ASO</option>
              <option value="SEO">SEO</option>
            </select>
            <label>Какой бюджет в среднем отливаешь в месяц?</label>
            <select name="budget" required>
              <option value="" disabled selected>Выберите бюджет</option>
              <option value="Менее $1 000">Менее $1 000</option>
              <option value="$1 000-$5 000">$1 000-$5 000</option>
              <option value="$5 000-$10 000">$5 000-$10 000</option>
              <option value="$10 000-$20 000">$10 000-$20 000</option>
            </select>
            <label>Расскажи о своём последнем опыте на схожей позиции</label>
            <textarea name="last_experience" placeholder="Оформленный кейс или резюме будет плюсом" required></textarea>
          `;
        } else {
          formContent += `
            <label>На какой позиции ты сейчас?</label>
            <select name="position" required>
              <option value="" disabled selected>Выберите пункт</option>
              <option value="Другое">Другое</option>
              <option value="Владелец команды">Владелец команды</option>
              <option value="Тимлид">Тимлид</option>
              <option value="Медиабайер">Медиабайер</option>
            </select>
            <label>Как тебя зовут?</label>
            <input type="text" name="name" placeholder="Ваше имя" required>
            <label>В каком городе ты живёшь?</label>
            <input type="text" name="city" placeholder="Город" required>
            <label>Каков твой опыт в вертикалях iGaming/Betting/Finance?</label>
            <select name="experience" required>
              <option value="" disabled selected>Выберите пункт</option>
              <option value="3+ года">3+ года</option>
              <option value="1-2 года">1-2 года</option>
              <option value="6-12 месяцев">6-12 месяцев</option>
              <option value="менее 6 месяцев">менее 6 месяцев</option>
            </select>
            <label>Твой источник?</label>
            <select name="source" required>
              <option value="" disabled selected>Выберите пункт</option>
              <option value="FB">FB</option>
              <option value="PPC">PPC</option>
              <option value="ASO">ASO</option>
              <option value="SEO">SEO</option>
            </select>
            <label>Какой бюджет в среднем отливаешь в месяц?</label>
            <select name="budget" required>
              <option value="" disabled selected>Выберите пункт</option>
              <option value="Менее $1 000">Менее $1 000</option>
              <option value="$1 000-$5 000">$1 000-$5 000</option>
              <option value="$5 000-$10 000">$5 000-$10 000</option>
              <option value="$10 000-$20 000">$10 000-$20 000</option>
            </select>
            <label>Расскажи о своём последнем опыте на схожей позиции</label>
            <textarea name="last_experience" placeholder="Оформленный кейс или резюме будет плюсом" required></textarea>
          `;
        }
      } else {
        formContent += `
          <label>Как тебя зовут?</label>
          <input type="text" name="name" placeholder="Ваше имя" required>
          <label>В каком городе ты живёшь?</label>
          <input type="text" name="city" placeholder="Город" required>
          <label>Расскажи о своём опыте на схожих позициях</label>
          <textarea name="experience" placeholder="Опишите свой опыт" required></textarea>
          <label>Ссылка на резюме (если есть)</label>
          <input type="url" name="resume" placeholder="https://">
        `;
      }
      return formContent;
    }

    // Показ формы сразу при клике
    document.querySelectorAll('#vacancies .card, #vacancies .promo-card').forEach(card => {
      card.addEventListener('click', () => {
        const vacancyId = card.dataset.vacancyId;
        const data = vacancyData[vacancyId];
        if (!data) return;
        trackEvent('vacancy_view', { vacancy: data.title });
        const response_id = generateUUID();
        showFormModal(vacancyId, data, response_id);
      });
    });

    function showFormModal(vacancyId, data, response_id) {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <h3>${data.title}</h3>
        <form class="apply-form">
          ${renderForm(vacancyId)}
          <button type="submit">Отправить заявку</button>
          <button type="button" class="close-button">Закрыть</button>
        </form>
      `;
      document.body.appendChild(modal);
      modal.querySelector('.close-button').addEventListener('click', () => modal.remove());
      modal.querySelector('.apply-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const telegram = formData.get('telegram');
        if (telegram && !telegram.startsWith('@')) {
          tg.showPopup({ title: 'Ошибка', message: 'Telegram-username должен начинаться с @', buttons: [{ type: 'ok' }] });
          return;
        }
        const additional = { id: vacancyId, title: data.title, response_id };
        for (const [key, value] of formData.entries()) additional[key] = value;
        sendToSheet({
          event: 'vacancy_apply_pending',
          user_id,
          username,
          first_name,
          last_name,
          timestamp: new Date().toISOString(),
          additional
        });
        // Переходим к подписке
        modal.innerHTML = `
          <h3>${data.title}</h3>
          <p>Ваша заявка принята, но чтобы мы могли уведомить вас о статусе, подпишитесь на бота:</p>
          <a href="https://t.me/bbb909test_bot?start=apply_${response_id}" target="_blank" class="subscribe-button">Подписаться</a>
          <button class="check-subscription">Проверить подписку</button>
          <button type="button" class="close-button">Закрыть</button>
        `;
        modal.querySelector('.close-button').addEventListener('click', () => modal.remove());
        modal.querySelector('.check-subscription').addEventListener('click', () => {
          checkSubscription(response_id, (isSubscribed) => {
            if (isSubscribed) {
              fetch(SHEET_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  event: 'vacancy_confirm_subscription',
                  user_id,
                  username,
                  first_name,
                  last_name,
                  timestamp: new Date().toISOString(),
                  additional: { response_id }
                })
              })
              .then(res => res.json())
              .then(data => {
                tg.showPopup({ title: 'Успех!', message: 'Вы подписаны, HR уведомлён.', buttons: [{ type: 'ok' }] });
                modal.remove();
              })
              .catch(err => {
                tg.showPopup({ title: 'Ошибка', message: 'Не удалось подтвердить подписку. Попробуйте позже.', buttons: [{ type: 'ok' }] });
              });
            } else {
              tg.showPopup({ title: 'Подписка не подтверждена', message: 'Подпишитесь на бота и нажмите /start, затем повторите проверку.', buttons: [{ type: 'ok' }] });
            }
          });
        });
      });
    }

    function checkSubscription(response_id, callback) {
      fetch(SHEET_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          event: 'check_subscription',
          user_id,
          additional: { response_id }
        })
      })
      .then(response => response.json())
      .then(data => callback(!!data.subscribed))
      .catch(() => callback(false));
    }

    // Карусель
    function startCarousel() {
      const slides = document.querySelectorAll('.carousel a');
      const dots = document.querySelectorAll('.carousel-dots .dot');
      let currentIndex = 0;
      if (slides.length) {
        function showSlide(i) {
          slides.forEach((s, idx) => s.classList.toggle('active', idx===i));
          dots.forEach((d, idx) => d.classList.toggle('active', idx===i));
          currentIndex = i;
        }
        function nextSlide() {
          showSlide((currentIndex+1)%slides.length);
        }
        setInterval(nextSlide, 3000);
        showSlide(0);
      }
    }
    startCarousel();
  </script>
</body>
</html>

